{% extends "base.html" %}

{% block pageid %}listing{% endblock pageid %}

{% block title %}Liste des autorisations - {{ super() }}{% endblock title %}
{% block h1 %}Liste des autorisations{% endblock h1 %}

{% block content %}

<script>
  // On first load, we get immediate value for pagination
  // instead of waiting for an AJAX request.
  window.PRELOAD_PAGINATION = {
    status: "{{ selected_auth_status }}",
    month: "{{ selected_month }}",
    year: "{{ selected_year }}"
  }
</script>

<section class="container" ng-controller="AuthListingCtrl as vm">


  <header class="listing-header row">
    <nav class="col-lg-7 col-md-12">
      <ul>

        <li>
          <label>Autorisations</label>
          <select name="auth_type"
                  ng-change="vm.refresh()"
                  ng-model="vm.pagination.status">
            {% for value, name in auth_status.items() %}
              <option value="{{ value }}"
                      {% if value == selected_auth_status %}selected{% endif %}>
                      {{ name }}
              </option>
            {% endfor %}
          </select>
        </li>
        <li>
          <label>en</label>
          <select name="month"
                  ng-change="vm.refresh()"
                  ng-model="vm.pagination.month">

            {% for i, month in months %}
              <option value="{{ i }}"
                      {% if i == selected_month %}selected{% endif %}>
                {{ month }}
              </option>
            {% endfor %}
          </select>
        </li>

        <li>
          <select name="year"
                  ng-change="vm.refresh()"
                  ng-model="vm.pagination.year">
            {% for value, name in years %}
              <option value="{{ value }}"
                      {% if value == selected_year %}selected{% endif %}>
                {{ name }}
              </option>
            {% endfor %}
          </select>

        </li>


      </ul>
    </nav>

    <div class="input-group search" class="col-lg-5 col-md-12">
      <input type="text" class="form-control"
            placeholder="Ex: Salèze + VM 89">
      <span class="input-group-btn">
        <button class="btn btn-default" type="button">
          <span class="glyphicon glyphicon-search"></span>
        </button>
      </span>
    </div>

  </header>


 <div ng-show="vm.loading" class="loading">
      <p ng-hide="vm.error">
        <img src="/static/img/spinner.gif" class="spinner" />
        Chargement des autorisations
      </p>
      <p ng-show="vm.error" class="alert alert-warning ng-cloak">
      {% raw %}
        {{ vm.error }}
      {% endraw %}
      </p>
  </div>

  <p ng-hide="vm.loading || vm.authorizations.listing.length" class="alert alert-success">
    Aucune autorisation trouvée
  </p>

  <table ng-hide="vm.loading" class="table auth-list ng-cloak">

    <thead>
      <tr>
        <th class="date">Dates</th>
        <th class="candidate">Demandeur</th>
        <th>Lieux</th>
        <th>Véhicules</th>
        <th class="document">Document</th>
        <th class="edit"></th>
      </tr>
    </thead>

    <tbody>

      <tr ng-repeat="auth in vm.authorizations.listing">
        {% raw %}
        <td class="date">
            <span ng-if="auth.auth_start_date">
              Début : {{ auth.auth_start_date }}
            </span>
            <span class="hide"
                  ng-if="auth.auth_start_date && auth.auth_end_date">
              -
            </span>
            <span ng-if="auth.auth_end_date">
              Fin : {{ auth.auth_end_date }}
            </span>
        </td>


        <td class="candidate">
          <p ng-if="auth.author_name">
            <strong>
              <span ng-switch on="auth.author_gender">
                  <span ng-switch-when="Homme">
                      M.
                  </span>
                  <span ng-switch-when="Femme">
                      Mme.
                  </span>
                  <span ng-switch-default></span>
              </span>
              {{ auth.author_name }}
            </strong>
          </p>
          <p ng-if="auth.author_address">
            {{ auth.author_address }}
          </p>
          <p ng-if="auth.author_phone">
            ({{ auth.author_phone }})
          </p>
        </td>

        <td>{{ auth.places|join:', ':'name'}}</td>

        <td>{{ auth.vehicules|join:', '}}</td>

        <td class="document">
          <a href="#">2017-C0001 (TODO)</a>
        </td>

        <td class="edit">
          <a href="/"><span class="glyphicon glyphicon-pencil"></span></a>
          <a href="/"><span class="glyphicon glyphicon-duplicate"></span></a>
          {{ auth.id }} - {{ auth.created }}
        </td>

        {% endraw %}

      </tr>

    </tbody>

  </table>


  <footer class="listing-footer" ng-hide="vm.loading" class="ng-cloak">
    {% raw %}
    <p>
      <strong>Total</strong>:
      {{ vm.authorizations.listing.length }}
    </p>
    {% endraw %}
    <dl>
      <dt>Exporter cette liste en:</dt>

      <!--
          TODO:
          Add attribution to gliphycons and those icons
         Icon made by <a title="Freepik" href="http://www.freepik.com">Freepik</a> from <a title="Flaticon" href="http://www.flaticon.com">www.flaticon.com</a>
      -->
      <dd>
        <a href="#">
          .ods
          <img alt="Télécharger en tant que ODS" class="file-icon"
               src="{{ url_for('static', filename='img/ods.svg') }}">
        </a>
      </dd>
      <dd>
        <a href="#">
          .pdf
          <img alt="Télécharger en tant que ODS" class="file-icon"
               src="{{ url_for('static', filename='img/pdf.svg') }}">
        </a>
      </dd>
    </dl>
  </footer>

</section>
{% endblock content %}
